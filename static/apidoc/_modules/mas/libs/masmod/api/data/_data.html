

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mas.libs.masmod.api.data._data &#8212; masmod  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../../../../../" id="documentation_options" src="../../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../../_static/jquery.js"></script>
    <script src="../../../../../../_static/underscore.js"></script>
    <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../../../_static/doctools.js"></script>
    <script src="../../../../../../_static/sphinx_highlight.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/mas/libs/masmod/api/data/_data';</script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../../../../index.html">
  
  
  
  
  
    <p class="title logo__title">masmod  documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">mas.libs.masmod.api.data._data</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for mas.libs.masmod.api.data._data</h1><div class="highlight"><pre>
<span></span><span class="c1"># _*_ coding: utf-8 _*_</span>
<span class="c1">############################################################</span>
<span class="c1"># File: @mas/masmod\api\data\_data.py</span>
<span class="c1">#</span>
<span class="c1"># Author: 姚泽 &lt;ze.yao@drugchina.net&gt;</span>
<span class="c1">#</span>
<span class="c1"># File Created: 05/16/2023 02:38 pm</span>
<span class="c1">#</span>
<span class="c1"># Last Modified: 06/19/2023 06:33 pm</span>
<span class="c1">#</span>
<span class="c1"># Modified By: 姚泽 &lt;ze.yao@drugchina.net&gt;</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2023 MaS Dev Team</span>
<span class="c1">############################################################</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">cast</span><span class="p">,</span> <span class="n">overload</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas._typing</span> <span class="kn">import</span> <span class="n">Dtype</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_categorical_dtype</span><span class="p">,</span> <span class="n">is_integer_dtype</span><span class="p">,</span> <span class="n">is_string_dtype</span>

<span class="kn">from</span> <span class="nn">mas.libs.ditto.build._ditto.pk.event</span> <span class="kn">import</span> <span class="n">DittoDataRecord</span><span class="p">,</span> <span class="n">DittoEValue</span><span class="p">,</span> <span class="n">DittoEventType</span><span class="p">,</span> <span class="n">DittoIndividualData</span>
<span class="kn">from</span> <span class="nn">mas.libs.masmod.api.data._common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseArrayFloatType</span><span class="p">,</span>
    <span class="n">BaseArrayIdType</span><span class="p">,</span>
    <span class="n">BaseArrayIntType</span><span class="p">,</span>
    <span class="n">check_unit</span><span class="p">,</span>
    <span class="n">cmt_value_check</span><span class="p">,</span>
    <span class="n">iterable_to_list</span><span class="p">,</span>
    <span class="n">parse_float_array_like</span><span class="p">,</span>
    <span class="n">parse_int_array_like</span><span class="p">,</span>
    <span class="n">parse_record</span><span class="p">,</span>
    <span class="n">to_event_type</span><span class="p">,</span>
    <span class="n">value_grate_equal_check</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mas.libs.masmod.module._interpret</span> <span class="kn">import</span> <span class="n">InterpretedModule</span>
<span class="kn">from</span> <span class="nn">mas.libs.masmod.plot.explore</span> <span class="kn">import</span> <span class="n">BivariatePlot</span><span class="p">,</span> <span class="n">ContourPlot</span><span class="p">,</span> <span class="n">CovariatesPlot</span>
<span class="kn">from</span> <span class="nn">mas.libs.maspy.pandas.dataframe</span> <span class="kn">import</span> <span class="n">MasDataFrame</span>
<span class="kn">from</span> <span class="nn">mas.libs.maspy.units</span> <span class="kn">import</span> <span class="n">Unit</span><span class="p">,</span> <span class="n">unit_convert</span>
<span class="kn">from</span> <span class="nn">mas.libs.maspy.units.basic_units</span> <span class="kn">import</span> <span class="n">RatioUnit</span>

<span class="n">ValueType</span> <span class="o">=</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span>
<span class="n">DataMappingType</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;idv&quot;</span><span class="p">,</span> <span class="s2">&quot;dv&quot;</span><span class="p">,</span> <span class="s2">&quot;mdv&quot;</span><span class="p">,</span> <span class="s2">&quot;amt&quot;</span><span class="p">,</span> <span class="s2">&quot;cmt&quot;</span><span class="p">,</span> <span class="s2">&quot;evid&quot;</span><span class="p">,</span> <span class="s2">&quot;ii&quot;</span><span class="p">,</span> <span class="s2">&quot;addl&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;dur&quot;</span><span class="p">,</span> <span class="s2">&quot;ss&quot;</span><span class="p">]</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ModelData&quot;</span><span class="p">,</span> <span class="s2">&quot;et&quot;</span><span class="p">,</span> <span class="s2">&quot;_to_ditto_individual_data&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ColumnMapValues</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">COLUMN_MAP_VALUES_ID</span> <span class="o">=</span> <span class="s2">&quot;ID&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_TIME</span> <span class="o">=</span> <span class="s2">&quot;TIME&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_DV</span> <span class="o">=</span> <span class="s2">&quot;DV&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_CMT</span> <span class="o">=</span> <span class="s2">&quot;CMT&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_EVID</span> <span class="o">=</span> <span class="s2">&quot;EVID&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_AMT</span> <span class="o">=</span> <span class="s2">&quot;AMT&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_RATE</span> <span class="o">=</span> <span class="s2">&quot;RATE&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_DUR</span> <span class="o">=</span> <span class="s2">&quot;DUR&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_ADDL</span> <span class="o">=</span> <span class="s2">&quot;ADDL&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_II</span> <span class="o">=</span> <span class="s2">&quot;II&quot;</span>
    <span class="n">COLUMN_MAP_VALUES_SS</span> <span class="o">=</span> <span class="s2">&quot;SS&quot;</span>


<span class="n">SelfType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;SelfType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;ModelData&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="ModelData"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.ModelData">[docs]</a><span class="k">class</span> <span class="nc">ModelData</span><span class="p">(</span><span class="n">MasDataFrame</span><span class="p">):</span>
    <span class="c1">#默认列数据类型</span>
    <span class="n">_default_col_dtypes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;TIME&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DV&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CMT&quot;</span><span class="p">:</span> <span class="s2">&quot;Int64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;EVID&quot;</span><span class="p">:</span> <span class="s2">&quot;Int64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AMT&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RATE&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DUR&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ADDL&quot;</span><span class="p">:</span> <span class="s2">&quot;Int64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;II&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SS&quot;</span><span class="p">:</span> <span class="s2">&quot;Int64&quot;</span>
    <span class="p">}</span>

    <span class="c1"># 缓存 id</span>
    <span class="n">_cache_id</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_default_col_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;ID&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;TIME&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dv&quot;</span><span class="p">:</span> <span class="s2">&quot;DV&quot;</span><span class="p">,</span>
        <span class="s2">&quot;amt&quot;</span><span class="p">:</span> <span class="s2">&quot;AMT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cmt&quot;</span><span class="p">:</span> <span class="s2">&quot;CMT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;evid&quot;</span><span class="p">:</span> <span class="s2">&quot;EVID&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ii&quot;</span><span class="p">:</span> <span class="s2">&quot;II&quot;</span><span class="p">,</span>
        <span class="s2">&quot;addl&quot;</span><span class="p">:</span> <span class="s2">&quot;ADDL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ss&quot;</span><span class="p">:</span> <span class="s2">&quot;SS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;RATE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dur&quot;</span><span class="p">:</span> <span class="s2">&quot;DUR&quot;</span>
    <span class="p">}</span>

    <span class="n">_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_cache_id&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelData</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">Dtype</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">amt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ii</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">addl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dur</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ss</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ModelData construct</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Any, optional): the data to construct model data, see also pandas DataFrame.__init__ data. Defaults to None.</span>
<span class="sd">            index (Collection[Any] | None, optional):  model data index, see also pandas DataFrame.__init__ index. Defaults to None.</span>
<span class="sd">            columns (Collection[Any] | None, optional): model data columns, see also pandas DataFrame.__init__ columns. Defaults to None.</span>
<span class="sd">            dtype (Dtype | None, optional): model data dtype. see also pandas DataFrame.__init__ dtype, Defaults to None.</span>
<span class="sd">            copy (bool, optional): Copy data from inputs data. see also pandas DataFrame.__init__ copy, Defaults to False.</span>
<span class="sd">            id (str | None, optional): Specifies the id column of the mapping. default None.</span>
<span class="sd">            idv (str | None, optional): Specifies the idv column of the mapping, which is mutually exclusive with time. If one is specified, the other cannot be specified. default None</span>
<span class="sd">            dv (str | None, optional): Specifies the dv column of the mapping. default None.</span>
<span class="sd">            amt (str | None, optional): Specifies the amt column of the mapping. default None.</span>
<span class="sd">            cmt (str | None, optional): Specifies the cmt column of the mapping. default None.</span>
<span class="sd">            evid (str | None, optional): Specifies the evid column of the mapping. default None.</span>
<span class="sd">            ii (str | None, optional): Specifies the ii column of the mapping. default None.</span>
<span class="sd">            addl (str | None, optional): Specifies the addl column of the mapping. default None.</span>
<span class="sd">            rate (str | None, optional): Specifies the rate column of the mapping. default None.</span>
<span class="sd">            dur (str | None, optional): Specifies the dur column of the mapping. default None.</span>
<span class="sd">            ss (str | None, optional): Specifies the ss column of the mapping. default None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">Dtype</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">idv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">amt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ii</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">addl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dur</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ss</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ModelData construct</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Any, optional): the data to construct model data, see also pandas DataFrame.__init__ data. Defaults to None.</span>
<span class="sd">            index (Collection[Any] | None, optional):  model data index, see also pandas DataFrame.__init__ index. Defaults to None.</span>
<span class="sd">            columns (Collection[Any] | None, optional): model data columns, see also pandas DataFrame.__init__ columns. Defaults to None.</span>
<span class="sd">            dtype (Dtype | None, optional): model data dtype. see also pandas DataFrame.__init__ dtype, Defaults to None.</span>
<span class="sd">            copy (bool, optional): Copy data from inputs data. see also pandas DataFrame.__init__ copy, Defaults to False.</span>
<span class="sd">            id (str | None, optional): Specifies the id column of the mapping. default None.</span>
<span class="sd">            idv (str | None, optional): Specifies the idv column of the mapping, which is mutually exclusive with time. If one is specified, the other cannot be specified. default None</span>
<span class="sd">            dv (str | None, optional): Specifies the dv column of the mapping. default None.</span>
<span class="sd">            amt (str | None, optional): Specifies the amt column of the mapping. default None.</span>
<span class="sd">            cmt (str | None, optional): Specifies the cmt column of the mapping. default None.</span>
<span class="sd">            evid (str | None, optional): Specifies the evid column of the mapping. default None.</span>
<span class="sd">            ii (str | None, optional): Specifies the ii column of the mapping. default None.</span>
<span class="sd">            addl (str | None, optional): Specifies the addl column of the mapping. default None.</span>
<span class="sd">            rate (str | None, optional): Specifies the rate column of the mapping. default None.</span>
<span class="sd">            dur (str | None, optional): Specifies the dur column of the mapping. default None.</span>
<span class="sd">            ss (str | None, optional): Specifies the ss column of the mapping. default None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">Dtype</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MasDataFrame</span><span class="p">):</span>
            <span class="n">kwd_mapping</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">kwd_mapping</span>
            <span class="c1"># data.kwd_mapping = {}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwd_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__meta_init</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MasDataFrame</span><span class="p">):</span>
            <span class="c1"># 初始化单位，</span>
            <span class="c1"># 时间以 time 映射为主时间单位， 其他时间单位看齐 time 单位</span>
            <span class="c1"># 剂量以 amt 映射单位为主剂量单位，</span>
            <span class="c1"># rate 为滴注速率单位</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__unit_init</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__kwd_mapping_init</span><span class="p">(</span><span class="n">kwd_mapping</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__kwd_mapping_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwd_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_kwd_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">_col</span> <span class="ow">in</span> <span class="n">kwd_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">new_kwd_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_keyword</span><span class="p">(</span><span class="n">new_kwd_mapping</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unit_init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
        <span class="n">kwd_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span>
        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">kwd_mapping</span><span class="p">:</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;amt&quot;</span> <span class="ow">in</span> <span class="n">kwd_mapping</span><span class="p">:</span>
            <span class="n">amt_unit</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;amt&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amt_unit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;rate&quot;</span> <span class="ow">in</span> <span class="n">kwd_mapping</span><span class="p">:</span>
            <span class="n">rate_unit</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rate_unit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">data_unit_covert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="n">time_unit</span><span class="p">,</span> <span class="n">amt_unit</span><span class="o">=</span><span class="n">amt_unit</span><span class="p">,</span> <span class="n">rate_unit</span><span class="o">=</span><span class="n">rate_unit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__meta_init</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">idv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">amt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ii</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">addl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dur</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ss</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lower_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">lower_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MasData columns name must be string type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lower_columns</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ModelData cannot have duplicate column names&quot;</span><span class="p">)</span>

        <span class="n">kwd_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 校验 time idv, 互斥</span>
        <span class="n">mapped_column</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">and</span> <span class="n">idv</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ModelData can only has either a time column or a idv column&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">idv</span><span class="p">:</span>  <span class="c1"># time</span>
            <span class="k">if</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>
                <span class="n">mapped_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2"> not in data&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">time</span> <span class="ow">and</span> <span class="n">idv</span><span class="p">:</span>  <span class="c1"># idv</span>
            <span class="k">if</span> <span class="n">idv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idv</span>
                <span class="n">mapped_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2"> not in data&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 自动推断, 优先 time</span>
            <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">lower_columns</span> <span class="ow">and</span> <span class="s2">&quot;idv&quot;</span> <span class="ow">in</span> <span class="n">lower_columns</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;ModelData can only has either a time column or a idv column, the &#39;</span><span class="si">{}</span><span class="s2">&#39; column is not automatically mapped&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">col_index</span> <span class="o">=</span> <span class="n">lower_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
                <span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col_index</span><span class="p">])</span>
                <span class="n">mapped_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col_index</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">lower_columns</span><span class="p">:</span>
                <span class="n">col_index</span> <span class="o">=</span> <span class="n">lower_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
                <span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col_index</span><span class="p">])</span>
                <span class="n">mapped_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col_index</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="s2">&quot;idv&quot;</span> <span class="ow">in</span> <span class="n">lower_columns</span><span class="p">:</span>
                <span class="n">col_index</span> <span class="o">=</span> <span class="n">lower_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;idv&quot;</span><span class="p">)</span>
                <span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col_index</span><span class="p">])</span>
                <span class="n">mapped_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col_index</span><span class="p">]))</span>

        <span class="n">_auto_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span>
            <span class="s2">&quot;dv&quot;</span><span class="p">:</span> <span class="n">dv</span><span class="p">,</span>
            <span class="s2">&quot;amt&quot;</span><span class="p">:</span> <span class="n">amt</span><span class="p">,</span>
            <span class="s2">&quot;cmt&quot;</span><span class="p">:</span> <span class="n">cmt</span><span class="p">,</span>
            <span class="s2">&quot;evid&quot;</span><span class="p">:</span> <span class="n">evid</span><span class="p">,</span>
            <span class="s2">&quot;ii&quot;</span><span class="p">:</span> <span class="n">ii</span><span class="p">,</span>
            <span class="s2">&quot;addl&quot;</span><span class="p">:</span> <span class="n">addl</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="n">rate</span><span class="p">,</span>
            <span class="s2">&quot;dur&quot;</span><span class="p">:</span> <span class="n">dur</span><span class="p">,</span>
            <span class="s2">&quot;ss&quot;</span><span class="p">:</span> <span class="n">ss</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">_col</span> <span class="ow">in</span> <span class="n">_auto_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_col</span><span class="p">:</span>  <span class="c1"># 指定 id mapping</span>
                <span class="k">if</span> <span class="n">_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapped_column</span><span class="p">:</span>
                        <span class="n">kwd_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_col</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_col</span><span class="si">}</span><span class="s2"> map column </span><span class="si">{</span><span class="n">_col</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">_col</span><span class="si">}</span><span class="s2"> is mapped others&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_col</span><span class="si">}</span><span class="s2"> not in data&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># 未指定， 尝试自动映射</span>
                <span class="k">if</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">lower_columns</span><span class="p">:</span>
                    <span class="n">col_index</span> <span class="o">=</span> <span class="n">lower_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">_key</span><span class="p">)</span>
                    <span class="n">kwd_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col_index</span><span class="p">])</span>

        <span class="c1"># 自动映射映射 MDV</span>
        <span class="k">if</span> <span class="s1">&#39;mdv&#39;</span> <span class="ow">in</span> <span class="n">lower_columns</span><span class="p">:</span>
            <span class="n">col_index</span> <span class="o">=</span> <span class="n">lower_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;mdv&quot;</span><span class="p">)</span>
            <span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;mdv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col_index</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">map_keyword</span><span class="p">(</span><span class="n">kwd_mapping</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ModelData</span><span class="p">]:</span>

        <span class="k">def</span> <span class="nf">constructor</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ModelData&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ModelData</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># 保留 meta</span>
            <span class="n">data</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># type:ignore</span>
            <span class="n">data</span><span class="o">.</span><span class="n">locks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks</span>
            <span class="n">data</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>
            <span class="n">data</span><span class="o">.</span><span class="n">precisions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precisions</span>
            <span class="c1"># TODO: 考虑 kwd_mapping 实现为 MasSeries 属性</span>
            <span class="n">data</span><span class="o">.</span><span class="n">kwd_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">return</span> <span class="n">constructor</span>
        <span class="c1"># return ModelData</span>

<div class="viewcode-block" id="ModelData.copy"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.ModelData.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">SelfType</span><span class="p">,</span> <span class="n">deep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SelfType</span><span class="p">:</span>
        <span class="n">instance</span><span class="p">:</span> <span class="n">SelfType</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">SelfType</span><span class="p">,</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__catch_meta</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span></div>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">SelfType</span><span class="p">,</span> <span class="n">memo</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SelfType</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_col</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_col_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>

<div class="viewcode-block" id="ModelData.add_dosing"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.ModelData.add_dosing">[docs]</a>    <span class="k">def</span> <span class="nf">add_dosing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">SelfType</span><span class="p">,</span>
        <span class="n">amt</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">time</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">addl</span><span class="p">:</span> <span class="n">BaseArrayIntType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ii</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cmt</span><span class="p">:</span> <span class="n">BaseArrayIntType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rate</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dur</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ss</span><span class="p">:</span> <span class="n">BaseArrayIntType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">amt_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">BaseArrayIdType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># expand_from_next: bool = True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SelfType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;add dosing to model data</span>

<span class="sd">    	Args:</span>
<span class="sd">            amt: Amount of the dose.</span>
<span class="sd">            time: The time of the dose or the sampling times, default None. if not specified, it used with 0.</span>
<span class="sd">            addl: The number of additional doses at a inter-dose interval after one dose. default None.</span>
<span class="sd">            ii: When specifying a dose, this is the inter-dose interval for ss, addl and until options, default None.</span>
<span class="sd">            cmt: Compartment number. this is an integer starting at 1.</span>
<span class="sd">            rate: When positive, this is the rate of infusion. Otherwise:</span>
<span class="sd">                Value Description</span>
<span class="sd">                0	No infusion is on this record</span>
<span class="sd">                -1	Modeled rate .</span>
<span class="sd">                -2	Modeled duration..</span>
<span class="sd">            dur: Duration of infusion. When amt and dur are specified the rate is calculated from the two data items. When dur is specified instead of rate, the bioavailability changes will increase rate instead of duration.</span>
<span class="sd">            ss: Steady state flag; It can be one of:</span>
<span class="sd">                Value Description</span>
<span class="sd">                0	This dose is not a steady state dose</span>
<span class="sd">                1	This dose is a steady state dose with the between/inter-dose interval of ii</span>
<span class="sd">                2	Superposition steady state</span>
<span class="sd">            amt_unit: The unit for amount. default None.</span>
<span class="sd">            time_unit: The unit for time. default None.</span>
<span class="sd">            id: A integer vector or string vector of IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 给药必须存在 time 映射</span>
        <span class="n">time_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">time_colname</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No time mapping in the data&quot;</span><span class="p">)</span>

        <span class="c1"># 不存在 AMT 映射, 补充 AMT 列</span>
        <span class="n">amt_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amt&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">amt_colname</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;AMT&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">amt_colname</span> <span class="o">=</span> <span class="s2">&quot;AMT&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;AMT in data, but not mapped&quot;</span><span class="p">)</span>

        <span class="c1"># 给药必提供 amt</span>
        <span class="k">if</span> <span class="n">amt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;amt must provide a number greater than 0&quot;</span><span class="p">)</span>

        <span class="n">_time_unit</span> <span class="o">=</span> <span class="n">check_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">time_unit</span><span class="p">)</span>
        <span class="n">_time</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span>
            <span class="n">time</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">check_func</span><span class="o">=</span><span class="n">value_grate_equal_check</span><span class="p">,</span> <span class="n">size_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_unit</span><span class="o">=</span><span class="n">_time_unit</span>
        <span class="p">)</span>
        <span class="n">base_time_unit</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">unit</span>

        <span class="n">_amt_unit</span> <span class="o">=</span> <span class="n">check_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">amt_unit</span><span class="p">)</span>
        <span class="n">_amt</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span><span class="n">amt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;amt&quot;</span><span class="p">,</span> <span class="n">size_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_unit</span><span class="o">=</span><span class="n">_amt_unit</span><span class="p">)</span>
        <span class="n">base_amt_unit</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">unit</span>

        <span class="c1"># 校验大小并计算最终 time 和 amt</span>
        <span class="k">if</span> <span class="n">_time</span><span class="o">.</span><span class="n">is_none</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_amt</span><span class="o">.</span><span class="n">is_none</span><span class="p">:</span>
            <span class="n">n_dose</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
            <span class="n">_amt_values</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">result</span>
            <span class="n">_amt_unit</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">_time_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dose</span>
            <span class="n">_time_unit</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># not _time.is_none and not _amt.is_none:</span>
            <span class="n">_amt_values</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">result</span>
            <span class="n">_amt_unit</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">_time_values</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">result</span>
            <span class="n">_time_unit</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">unit</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_time_values</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">result</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_amt_values</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">result</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time_values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt_values</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;time and amt lengths are inconsistent&quot;</span><span class="p">)</span>
            <span class="n">n_dose</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time_values</span><span class="p">)</span>

        <span class="n">_evid_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dose</span>

        <span class="n">_cmt</span> <span class="o">=</span> <span class="n">parse_int_array_like</span><span class="p">(</span><span class="n">cmt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cmt&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_dose</span><span class="p">,</span> <span class="n">check_func</span><span class="o">=</span><span class="n">cmt_value_check</span><span class="p">)</span>
        <span class="n">_ii</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span>
            <span class="n">ii</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ii&quot;</span><span class="p">,</span> <span class="n">expansion_size</span><span class="o">=</span><span class="n">n_dose</span><span class="p">,</span> <span class="n">base_unit</span><span class="o">=</span><span class="n">base_time_unit</span><span class="p">,</span> <span class="n">none_unit_convert</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">_addl</span> <span class="o">=</span> <span class="n">parse_int_array_like</span><span class="p">(</span><span class="n">addl</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;addl&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_dose</span><span class="p">)</span>
        <span class="n">_rate</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="n">expansion_size</span><span class="o">=</span><span class="n">n_dose</span><span class="p">)</span>

        <span class="n">_dur</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span>
            <span class="n">dur</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dur&quot;</span><span class="p">,</span> <span class="n">expansion_size</span><span class="o">=</span><span class="n">n_dose</span><span class="p">,</span> <span class="n">base_unit</span><span class="o">=</span><span class="n">base_time_unit</span><span class="p">,</span> <span class="n">none_unit_convert</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">_ss</span> <span class="o">=</span> <span class="n">parse_int_array_like</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ss&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_dose</span><span class="p">)</span>
        <span class="n">_dv_values</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dose</span>

        <span class="n">_data_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_col_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_col_mapping</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_col_mapping</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">_col_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">):</span>
                <span class="n">_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span>
                <span class="n">_data_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_colname</span>
            <span class="k">elif</span> <span class="n">_v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">_data_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_key</span> <span class="o">==</span> <span class="s2">&quot;evid&quot;</span> <span class="ow">or</span> <span class="n">_key</span> <span class="o">==</span> <span class="s2">&quot;amt&quot;</span><span class="p">:</span>  <span class="c1"># evid 和 amt 没有提供</span>
                    <span class="n">_data_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_v</span>

        <span class="k">for</span> <span class="n">_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dose</span><span class="p">):</span>
            <span class="n">_time_value</span> <span class="o">=</span> <span class="n">_time_values</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
            <span class="n">_dv_value</span> <span class="o">=</span> <span class="n">_dv_values</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
            <span class="n">_amt_value</span> <span class="o">=</span> <span class="n">_amt_values</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
            <span class="n">_cmt_value</span> <span class="o">=</span> <span class="n">_cmt</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
            <span class="n">_evid_value</span> <span class="o">=</span> <span class="n">_evid_values</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
            <span class="n">_rate_value</span> <span class="o">=</span> <span class="n">_rate</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
            <span class="n">_dur_value</span> <span class="o">=</span> <span class="n">_dur</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
            <span class="n">_addl_value</span> <span class="o">=</span> <span class="n">_addl</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
            <span class="n">_ii_value</span> <span class="o">=</span> <span class="n">_ii</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
            <span class="n">_ss_value</span> <span class="o">=</span> <span class="n">_ss</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>

            <span class="n">record</span> <span class="o">=</span> <span class="n">parse_record</span><span class="p">(</span>
                <span class="n">time</span><span class="o">=</span><span class="n">_time_value</span><span class="p">,</span>
                <span class="n">dv</span><span class="o">=</span><span class="n">_dv_value</span><span class="p">,</span>
                <span class="n">amt</span><span class="o">=</span><span class="n">_amt_value</span><span class="p">,</span>
                <span class="n">evid</span><span class="o">=</span><span class="n">_evid_value</span><span class="p">,</span>
                <span class="n">cmt</span><span class="o">=</span><span class="n">_cmt_value</span><span class="p">,</span>
                <span class="n">addl</span><span class="o">=</span><span class="n">_addl_value</span><span class="p">,</span>
                <span class="n">ii</span><span class="o">=</span><span class="n">_ii_value</span><span class="p">,</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">_dur_value</span><span class="p">,</span>
                <span class="n">rate</span><span class="o">=</span><span class="n">_rate_value</span><span class="p">,</span>
                <span class="n">ss</span><span class="o">=</span><span class="n">_ss_value</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">_index</span>
            <span class="p">)</span>
            <span class="n">_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">_data_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_values</span><span class="p">[</span><span class="n">_v</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_col_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]]</span>

            <span class="n">record</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">_values</span><span class="p">)</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_data</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">_id</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">iterable_to_list</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;id should be either a single integer value or list of integer&quot;</span><span class="p">)</span>

        <span class="n">id_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">id_colname</span><span class="p">:</span>  <span class="c1"># 源数据中有 ID</span>
            <span class="n">_data</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_data_rows</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="n">MasDataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_id</span><span class="p">),</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">_data</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">_data_rows</span><span class="p">)</span>  <span class="c1"># type:ignore</span>
            <span class="c1"># 按照 ID 和 TIME 排序</span>
            <span class="n">_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">id_colname</span><span class="p">,</span> <span class="n">time_colname</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 源数据中有 ID</span>
            <span class="n">_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">time_colname</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">ModelData</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">map_keyword</span><span class="p">(</span><span class="n">_data_mapping</span><span class="p">)</span>
        <span class="n">_units_set</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">base_time_unit</span><span class="p">,</span> <span class="n">base_amt_unit</span><span class="p">,</span> <span class="n">_rate</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="n">_data_mapping</span><span class="p">)</span>
        <span class="c1"># TODO: 合并时的协变量如何处理</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="ModelData.__add__"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.ModelData.__add__">[docs]</a>    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">SelfType</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">ModelData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SelfType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;concat model data with operator &#39;+&#39;&quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># ID 可以没有</span>
        <span class="n">id_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>  <span class="c1"># id1</span>
        <span class="n">other_id_colname</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>  <span class="c1"># id2</span>
        <span class="k">if</span> <span class="n">id_colname</span> <span class="ow">and</span> <span class="n">other_id_colname</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_colname</span> <span class="o">!=</span> <span class="n">other_id_colname</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The two data id mapping were inconsistent&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">other_id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_integer_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_integer_dtype</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">other_id_colname</span><span class="p">]))</span> \
                    <span class="ow">or</span> <span class="p">(</span><span class="n">is_string_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_string_dtype</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">other_id_colname</span><span class="p">])):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The two data id types were inconsistent&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">):</span>  <span class="c1"># 拼接必须存在 idv 映射</span>
            <span class="n">idv_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
            <span class="n">other_idv_colname</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">other_idv_colname</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idv_colname</span> <span class="o">!=</span> <span class="n">other_idv_colname</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The two data time mapping were inconsistent&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data has no time mapping&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idv&quot;</span><span class="p">):</span>
            <span class="n">idv_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">]</span>
            <span class="n">other_idv_colname</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idv&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">other_idv_colname</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idv_colname</span> <span class="o">!=</span> <span class="n">other_idv_colname</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The two data idv mapping is not equal&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data has no idv mapping&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data has no idv or time mapping&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mdv&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mdv&quot;</span><span class="p">):</span>
            <span class="n">mdv_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;mdv&quot;</span><span class="p">]</span>
            <span class="n">mdv_values</span> <span class="o">=</span> <span class="n">infer_mdv</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="n">other</span><span class="p">[</span><span class="n">mdv_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdv_values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mdv&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mdv&quot;</span><span class="p">):</span>
            <span class="n">mdv_colname</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;mdv&quot;</span><span class="p">]</span>
            <span class="n">mdv_values</span> <span class="o">=</span> <span class="n">infer_mdv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">mdv_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdv_values</span>

        <span class="c1"># 单位处理: 以 self 的单位为主</span>
        <span class="c1"># other = cast(ModelData, other.copy(deep=True))</span>
        <span class="n">idv_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">idv_colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>  <span class="c1"># 取时间单位</span>
        <span class="k">if</span> <span class="s2">&quot;amt&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">:</span>
            <span class="n">amt_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;amt&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amt_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;rate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">:</span>
            <span class="n">rate_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rate_unit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">other</span> <span class="o">=</span> <span class="n">data_unit_covert</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="n">idv_unit</span><span class="p">,</span> <span class="n">amt_unit</span><span class="o">=</span><span class="n">amt_unit</span><span class="p">,</span> <span class="n">rate_unit</span><span class="o">=</span><span class="n">rate_unit</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_append_other</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="n">_append_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">other</span><span class="p">])</span>
            <span class="n">_append_data</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type:ignore</span>
            <span class="k">return</span> <span class="n">_append_data</span>

        <span class="k">def</span> <span class="nf">_append_self</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="n">_append_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>
            <span class="n">_append_data</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type:ignore</span>
            <span class="k">return</span> <span class="n">_append_data</span>

        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">_cache_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 校验 self 的 id 是否存在</span>
                <span class="k">if</span> <span class="n">id_colname</span> <span class="ow">and</span> <span class="p">(</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The data id on the left exists&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_data_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_cache_id</span><span class="p">),</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_cache_id</span><span class="p">,</span> <span class="n">_data_rows</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">other</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 校验 other 的 id 是否存在</span>
                <span class="k">if</span> <span class="n">other_id_colname</span> <span class="ow">and</span> <span class="p">(</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">other_id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The data id on the left exists&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_data_rows</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_id</span><span class="p">),</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_id</span><span class="p">,</span> <span class="n">_data_rows</span><span class="p">)</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_colname</span> <span class="ow">and</span> <span class="n">other_id_colname</span><span class="p">:</span>  <span class="c1"># id 都存在</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">id_colname</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">id_colname</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_append_other</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">id_colname</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">id_colname</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_append_self</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;id has null value&quot;</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># TODO: 对 ID 排序会改变用户原有数据的 ID 顺序</span>
                <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">id_colname</span><span class="p">,</span> <span class="n">idv_colname</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">id_colname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other_id_colname</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>  <span class="c1"># id 为空</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">id_colname</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_append_other</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">id_colname</span><span class="p">,</span> <span class="n">idv_colname</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">id_colname</span> <span class="ow">and</span> <span class="n">other_id_colname</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">other_id_colname</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>  <span class="c1"># other id 为空</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">other_id_colname</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_append_self</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">other_id_colname</span><span class="p">,</span> <span class="n">idv_colname</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># id 都不存在</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">idv_colname</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;not yet&quot;</span><span class="p">)</span>

        <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">kwd_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span>
        <span class="n">res</span><span class="o">.</span><span class="n">map_keyword</span><span class="p">(</span><span class="n">kwd_mapping</span><span class="p">)</span>
        <span class="n">_units_set</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="n">idv_unit</span><span class="p">,</span> <span class="n">amt_unit</span><span class="o">=</span><span class="n">amt_unit</span><span class="p">,</span> <span class="n">rate_unit</span><span class="o">=</span><span class="n">rate_unit</span><span class="p">,</span> <span class="n">data_mapping</span><span class="o">=</span><span class="n">kwd_mapping</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">idv_colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">idv_colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="ModelData.add_sampling"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.ModelData.add_sampling">[docs]</a>    <span class="k">def</span> <span class="nf">add_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">SelfType</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">SelfType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add observation data to model data</span>

<span class="sd">        Args:</span>
<span class="sd">        	x: a list of time values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 新增观测必须存在 idv 映射</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">):</span>
            <span class="n">idv_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
            <span class="n">idv_name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idv&quot;</span><span class="p">):</span>
            <span class="n">idv_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">]</span>
            <span class="n">idv_name</span> <span class="o">=</span> <span class="s2">&quot;idv&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data has no idv or time mapping&quot;</span><span class="p">)</span>

        <span class="n">idv_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">idv_colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>
        <span class="c1"># 如果源没单位而 idv 给单位了, 报错</span>
        <span class="n">_idv</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;idv&quot;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_func</span><span class="o">=</span><span class="n">value_grate_equal_check</span><span class="p">,</span> <span class="n">size_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_unit</span><span class="o">=</span><span class="n">idv_unit</span>
        <span class="p">)</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_idv</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>

        <span class="n">value_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;evid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_obs</span>
        <span class="n">empty_col</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_obs</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;cmt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_col</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;ii&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_col</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;addl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_col</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;dur&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_col</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_col</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;ss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_col</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;dv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_col</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;amt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_col</span>
        <span class="n">value_map</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty_col</span>

        <span class="n">_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">idv_colname</span><span class="p">:</span> <span class="n">_idv</span><span class="o">.</span><span class="n">result</span><span class="p">})</span>
        <span class="n">_data_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">idv_name</span><span class="p">:</span> <span class="n">idv_colname</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">_col_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_col_mapping</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_col_mapping</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">_col_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_key</span><span class="p">):</span>
                <span class="n">_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span>
                <span class="n">_data</span><span class="p">[</span><span class="n">_colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_map</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span>
                <span class="n">_data_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_colname</span>
            <span class="k">elif</span> <span class="n">_v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  <span class="c1"># 是否与存在的必要</span>
                <span class="n">_data</span><span class="p">[</span><span class="n">_v</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_map</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span>
                <span class="n">_data_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_key</span> <span class="o">==</span> <span class="s2">&quot;evid&quot;</span><span class="p">:</span>
                    <span class="n">_data</span><span class="p">[</span><span class="n">_v</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_map</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span>
                    <span class="n">_data_mapping</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_v</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">_data</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">map_keyword</span><span class="p">(</span><span class="n">_data_mapping</span><span class="p">)</span>
        <span class="n">_units_set</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">_idv</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_data_mapping</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">add_covariates</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">covar</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add covariates to model data</span>

<span class="sd">        Args:</span>
<span class="sd">            id (Iterable[int  |  str] | None, optional): model data subject, if it is specify, the covariate data will update with id. Defaults to None.</span>
<span class="sd">            kwargs: covariate data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">add_covariates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">covar</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add covariates to model data</span>

<span class="sd">        Args:</span>
<span class="sd">            id (Iterable[int  |  str] | None, optional): model data subject, if it is specify, the covariate data will update with id. Defaults to None.</span>
<span class="sd">            kwargs: covariate data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

<div class="viewcode-block" id="ModelData.add_covariates"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.ModelData.add_covariates">[docs]</a>    <span class="k">def</span> <span class="nf">add_covariates</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add covariates to model data</span>

<span class="sd">        Args:</span>
<span class="sd">            id (Iterable[int  |  str] | None, optional): model data subject, if it is specify, the covariate data will update with id. Defaults to None.</span>
<span class="sd">            kwargs: covariate data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 校验大小写 column</span>
        <span class="n">lower_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">id_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="n">id_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
                <span class="n">value_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_values</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lower_columns</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2"> already in the data&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_values</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_values</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">id_size</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The length of </span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2"> does not match the length of id&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">value_counts</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_values</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lower_columns</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2"> already in the data&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_values</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is no id mapping in the data, covariate value must be a single value&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is no id mapping in data&quot;</span><span class="p">)</span>
            <span class="n">id_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="n">user_id_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">value_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_values</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lower_columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2"> already in the data&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_values</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_values</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">user_id_size</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The length of </span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2"> does not match the length of id&quot;</span><span class="p">)</span>
                    <span class="n">user_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">_values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="n">remain_id</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">value_counts</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">remain_id</span><span class="p">:</span>
                        <span class="n">remain_id_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">remain_id</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">remain_id</span><span class="p">))</span>
                        <span class="n">user_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">user_values</span><span class="p">,</span> <span class="n">remain_id_values</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>

                    <span class="n">user_values</span> <span class="o">=</span> <span class="n">user_values</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">id_colname</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">user_values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">value_counts</span><span class="p">)</span>  <span class="c1"># type:ignore</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_values</span></div>

    <span class="k">def</span> <span class="nf">__catch_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">ModelData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">map_keyword</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># type:ignore</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dosing</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">SelfType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SelfType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dosing data</span>

<span class="sd">        Returns:</span>
<span class="sd">            ModelData: Model data that contains only dosing record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evid&quot;</span><span class="p">):</span>
            <span class="n">evid_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;evid&quot;</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">SelfType</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">evid_colname</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mdv&quot;</span><span class="p">):</span>
            <span class="n">mdv_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s1">&#39;mdv&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amt&quot;</span><span class="p">):</span>
                <span class="n">amt_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s1">&#39;amt&#39;</span><span class="p">]</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[(</span><span class="bp">self</span><span class="p">[</span><span class="n">mdv_colname</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="p">[</span><span class="n">amt_colname</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;amt is not mapped&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amt&quot;</span><span class="p">):</span>
            <span class="n">amt_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s1">&#39;amt&#39;</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="p">[</span><span class="n">amt_colname</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;amt is not mapped&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__catch_meta</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">SelfType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SelfType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Observation data</span>

<span class="sd">        Returns:</span>
<span class="sd">            ModelData: Model data that contains only observational records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evid&quot;</span><span class="p">):</span>
            <span class="n">evid_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;evid&quot;</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">SelfType</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">evid_colname</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mdv&quot;</span><span class="p">):</span>
            <span class="n">mdv_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;mdv&quot;</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">SelfType</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">mdv_colname</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dv&quot;</span><span class="p">):</span>
            <span class="n">dv_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;dv&quot;</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">SelfType</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="p">[</span><span class="n">dv_colname</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dv is not mapped&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__catch_meta</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;the number of observation record&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reserved_colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">,</span> <span class="s2">&quot;dv&quot;</span><span class="p">,</span> <span class="s2">&quot;idv&quot;</span><span class="p">],</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The reserved column names</span>

<span class="sd">        Returns:</span>
<span class="sd">            the dict of keys with subject, dv and idv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="n">dv_colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dv&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">):</span>
            <span class="n">idv_coluname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idv&quot;</span><span class="p">):</span>
            <span class="n">idv_coluname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idv_coluname</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject_colname</span><span class="p">,</span> <span class="s2">&quot;dv&quot;</span><span class="p">:</span> <span class="n">dv_colname</span><span class="p">,</span> <span class="s2">&quot;idv&quot;</span><span class="p">:</span> <span class="n">idv_coluname</span>
        <span class="p">}</span>

<div class="viewcode-block" id="ModelData.explore_contour_plot"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.ModelData.explore_contour_plot">[docs]</a>    <span class="k">def</span> <span class="nf">explore_contour_plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_scale</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="n">y_scale</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContourPlot</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;the contour plot of data explore</span>

<span class="sd">        Args:</span>
<span class="sd">            x_scale (Literal[&quot;linear&quot;, &quot;log&quot;], optional): x axis scale type. Defaults to &quot;linear&quot;.</span>
<span class="sd">            y_scale (Literal[&quot;linear&quot;, &quot;log&quot;], optional): y axis scale type. Defaults to &quot;linear&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ContourPlot: Contour Plot Object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reserved_col_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserved_colnames</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">reserved_col_names</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span>
        <span class="n">idv_name</span> <span class="o">=</span> <span class="n">reserved_col_names</span><span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">]</span>
        <span class="n">dv_name</span> <span class="o">=</span> <span class="n">reserved_col_names</span><span class="p">[</span><span class="s2">&quot;dv&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">idv_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data explore must have idv mapping&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dv_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data explore must have dv mapping&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ContourPlot</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">subject_id_name</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">idv_name</span><span class="o">=</span><span class="n">idv_name</span><span class="p">,</span> <span class="n">dv_name</span><span class="o">=</span><span class="n">dv_name</span><span class="p">,</span> <span class="n">x_scale</span><span class="o">=</span><span class="n">x_scale</span><span class="p">,</span> <span class="n">y_scale</span><span class="o">=</span><span class="n">y_scale</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelData.explore_bivariate_plot"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.ModelData.explore_bivariate_plot">[docs]</a>    <span class="k">def</span> <span class="nf">explore_bivariate_plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dvid_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">x_dvid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y_dvid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">x_scale</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="n">y_scale</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BivariatePlot</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The bivariate plot of data explore</span>

<span class="sd">        Args:</span>
<span class="sd">            dvid_name (str): DVID column name</span>
<span class="sd">            x_dvid (str | float | int): dvid value of x axis.</span>
<span class="sd">            y_dvid (str | float | int): dvid value of y axis.</span>
<span class="sd">            x_scale (Literal[&quot;linear&quot;, &quot;log&quot;], optional): x axis scale type. Defaults to &quot;linear&quot;.</span>
<span class="sd">            y_scale (Literal[&quot;linear&quot;, &quot;log&quot;], optional): y axis scale type. Defaults to &quot;linear&quot;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: _description_</span>
<span class="sd">            ValueError: _description_</span>
<span class="sd">            ValueError: _description_</span>
<span class="sd">            ValueError: _description_</span>

<span class="sd">        Returns:</span>
<span class="sd">            BivariatePlot: _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reserved_col_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserved_colnames</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">reserved_col_names</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span>
        <span class="n">idv_name</span> <span class="o">=</span> <span class="n">reserved_col_names</span><span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">]</span>
        <span class="n">dv_name</span> <span class="o">=</span> <span class="n">reserved_col_names</span><span class="p">[</span><span class="s2">&quot;dv&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dvid_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dvid_name must be provider&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dvid_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dvid_name</span><span class="si">}</span><span class="s2"> not in data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idv_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data explore must have idv mapping&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dv_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data explore must have dv mapping&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">BivariatePlot</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">dvid_name</span><span class="o">=</span><span class="n">dvid_name</span><span class="p">,</span>
            <span class="n">subject_id_name</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
            <span class="n">idv_name</span><span class="o">=</span><span class="n">idv_name</span><span class="p">,</span>
            <span class="n">dv_name</span><span class="o">=</span><span class="n">dv_name</span><span class="p">,</span>
            <span class="n">x_dvid</span><span class="o">=</span><span class="n">x_dvid</span><span class="p">,</span>
            <span class="n">y_dvid</span><span class="o">=</span><span class="n">y_dvid</span><span class="p">,</span>
            <span class="n">x_scale</span><span class="o">=</span><span class="n">x_scale</span><span class="p">,</span>
            <span class="n">y_scale</span><span class="o">=</span><span class="n">y_scale</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ModelData.explore_covariates_plot"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.ModelData.explore_covariates_plot">[docs]</a>    <span class="k">def</span> <span class="nf">explore_covariates_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CovariatesPlot</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;covariates plot of data explore</span>

<span class="sd">        Args:</span>
<span class="sd">            ignore_columns (list[str] | None, optional): ignore columns, when it is specified The Plot will ignore columns. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CovariatesPlot: Covariate Plot Object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">covariates_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">classifications_variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reserved_col_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserved_colnames</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">reserved_col_names</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ignore_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_columns</span><span class="p">:</span>
                <span class="n">covariates_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_col</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_categorical_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">_col</span><span class="p">]):</span>
                    <span class="n">classifications_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_col</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CovariatesPlot</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">subject_id_name</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
            <span class="n">classifications_variables</span><span class="o">=</span><span class="n">classifications_variables</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="n">covariates_columns</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="et"><a class="viewcode-back" href="../../../../../../masmod.api.data.html#masmod.api.et">[docs]</a><span class="k">def</span> <span class="nf">et</span><span class="p">(</span>
    <span class="n">time</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">amt</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">evid</span><span class="p">:</span> <span class="n">BaseArrayIntType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cmt</span><span class="p">:</span> <span class="n">BaseArrayIntType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ii</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">addl</span><span class="p">:</span> <span class="n">BaseArrayIntType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ss</span><span class="p">:</span> <span class="n">BaseArrayIntType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rate</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dur</span><span class="p">:</span> <span class="n">BaseArrayFloatType</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BaseArrayFloatType</span><span class="p">,</span> <span class="n">Unit</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">BaseArrayIdType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">amt_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;build event table</span>

<span class="sd">    Args:</span>
<span class="sd">    	time: The time of the dose or the sampling times</span>
<span class="sd">    	amt: Amount of the dose. If specified, this assumes a dosing record, instead of a sampling record.</span>
<span class="sd">    	evid: Event ID,</span>
<span class="sd">            Value Description</span>
<span class="sd">            0	An observation.</span>
<span class="sd">            1	A dose observation.</span>
<span class="sd">            2	A non-dose event.</span>
<span class="sd">            3	A reset event.</span>
<span class="sd">            4	Dose and reset event.</span>

<span class="sd">    	cmt: Compartment number. this is an integer starting at 1</span>
<span class="sd">    	ii: When specifying a dose, this is the inter-dose interval for ss, addl and until options</span>
<span class="sd">    	addl: The number of additional doses at a inter-dose interval after one dose.</span>
<span class="sd">    	ss: Steady state flag; It can be one of:</span>
<span class="sd">            Value Description</span>
<span class="sd">            0	This dose is not a steady state dose</span>
<span class="sd">            1	This dose is a steady state dose with the between/inter-dose interval of ii</span>
<span class="sd">            2	Superposition steady state</span>

<span class="sd">    	rate: When positive, this is the rate of infusion. Otherwise:</span>
<span class="sd">            Value Description</span>
<span class="sd">            0	No infusion is on this record</span>
<span class="sd">            -1	Modeled rate .</span>
<span class="sd">            -2	Modeled duration.</span>
<span class="sd">    	dur: Duration of infusion. When amt and dur are specified the rate is calculated from the two data items. When dur is specified instead of rate, the bioavailability changes will increase rate instead of duration.</span>
<span class="sd">    	id: A integer vector or string vector of IDs.</span>
<span class="sd">    	amt_unit: The unit for amount.</span>
<span class="sd">    	time_unit: The unit for time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_id</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">_id</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">id</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;the `id` argument should be 1-dimension&#39;</span><span class="p">)</span>
        <span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="n">_id</span> <span class="o">=</span> <span class="n">iterable_to_list</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_id</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;id should be either a single integer value or list of integer&quot;</span><span class="p">)</span>

    <span class="n">_time_unit</span> <span class="o">=</span> <span class="n">check_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">time_unit</span><span class="p">)</span>
    <span class="n">_time</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span>
        <span class="n">time</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">check_func</span><span class="o">=</span><span class="n">value_grate_equal_check</span><span class="p">,</span> <span class="n">size_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_unit</span><span class="o">=</span><span class="n">_time_unit</span>
    <span class="p">)</span>
    <span class="n">base_time_unit</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">unit</span>
    <span class="n">_amt_unit</span> <span class="o">=</span> <span class="n">check_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">amt_unit</span><span class="p">)</span>
    <span class="n">_amt</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span><span class="n">amt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;amt&quot;</span><span class="p">,</span> <span class="n">size_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_unit</span><span class="o">=</span><span class="n">_amt_unit</span><span class="p">)</span>
    <span class="n">base_amt_unit</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">unit</span>

    <span class="n">n_record</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">_time</span><span class="o">.</span><span class="n">is_none</span> <span class="ow">and</span> <span class="n">_amt</span><span class="o">.</span><span class="n">is_none</span><span class="p">:</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">ModelData</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">ModelData</span><span class="o">.</span><span class="n">_default_col_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="o">**</span><span class="n">ModelData</span><span class="o">.</span><span class="n">_default_col_mapping</span><span class="p">)</span>
        <span class="n">_units_set</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="n">base_time_unit</span><span class="p">,</span> <span class="n">amt_unit</span><span class="o">=</span><span class="n">base_amt_unit</span><span class="p">,</span> <span class="n">rate_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_mapping</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">)</span>
        <span class="n">ev</span><span class="o">.</span><span class="n">_update_dtype</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">_cache_id</span> <span class="o">=</span> <span class="n">_id</span>  <span class="c1"># type:ignore</span>
        <span class="k">return</span> <span class="n">ev</span>
    <span class="k">elif</span> <span class="n">_time</span><span class="o">.</span><span class="n">is_none</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_amt</span><span class="o">.</span><span class="n">is_none</span><span class="p">:</span>
        <span class="n">n_record</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="n">_amt_values</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">result</span>
        <span class="n">_amt_unit</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">_time_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_record</span>
        <span class="n">_time_unit</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">unit</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">_time</span><span class="o">.</span><span class="n">is_none</span> <span class="ow">and</span> <span class="n">_amt</span><span class="o">.</span><span class="n">is_none</span><span class="p">:</span>
        <span class="n">n_record</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="n">_amt_values</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_record</span>
        <span class="n">_amt_unit</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">_time_values</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">result</span>
        <span class="n">_time_unit</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">unit</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># not _time.is_none and not _amt.is_none:</span>
        <span class="n">_amt_values</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">result</span>
        <span class="n">_amt_unit</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">_time_values</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">result</span>
        <span class="n">_time_unit</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_time_values</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">result</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_amt_values</span> <span class="o">=</span> <span class="n">_amt</span><span class="o">.</span><span class="n">result</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time_values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_amt_values</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;time and amt lengths are inconsistent&quot;</span><span class="p">)</span>
        <span class="n">n_record</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_time_values</span><span class="p">)</span>

    <span class="n">_evid</span> <span class="o">=</span> <span class="n">parse_int_array_like</span><span class="p">(</span><span class="n">evid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;evid&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_record</span><span class="p">)</span>
    <span class="n">_cmt</span> <span class="o">=</span> <span class="n">parse_int_array_like</span><span class="p">(</span><span class="n">cmt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cmt&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_record</span><span class="p">)</span>
    <span class="n">_ii</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span>
        <span class="n">ii</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ii&quot;</span><span class="p">,</span> <span class="n">expansion_size</span><span class="o">=</span><span class="n">n_record</span><span class="p">,</span> <span class="n">base_unit</span><span class="o">=</span><span class="n">base_time_unit</span><span class="p">,</span> <span class="n">none_unit_convert</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">_dur</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span>
        <span class="n">dur</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dur&quot;</span><span class="p">,</span> <span class="n">expansion_size</span><span class="o">=</span><span class="n">n_record</span><span class="p">,</span> <span class="n">base_unit</span><span class="o">=</span><span class="n">base_time_unit</span><span class="p">,</span> <span class="n">none_unit_convert</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">_rate</span> <span class="o">=</span> <span class="n">parse_float_array_like</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="n">expansion_size</span><span class="o">=</span><span class="n">n_record</span><span class="p">)</span>  <span class="c1"># TODO: rate 单位处理</span>
    <span class="n">_ss</span> <span class="o">=</span> <span class="n">parse_int_array_like</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ss&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_record</span><span class="p">)</span>
    <span class="n">_addl</span> <span class="o">=</span> <span class="n">parse_int_array_like</span><span class="p">(</span><span class="n">addl</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;addl&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_record</span><span class="p">)</span>
    <span class="n">_dv</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_record</span>

    <span class="n">_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">ModelData</span><span class="o">.</span><span class="n">_default_col_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_record</span><span class="p">):</span>
        <span class="n">_time_value</span> <span class="o">=</span> <span class="n">_time_values</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_dv_value</span> <span class="o">=</span> <span class="n">_dv</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_amt_value</span> <span class="o">=</span> <span class="n">_amt_values</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_cmt_value</span> <span class="o">=</span> <span class="n">_cmt</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_evid_value</span> <span class="o">=</span> <span class="n">_evid</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_rate_value</span> <span class="o">=</span> <span class="n">_rate</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_dur_value</span> <span class="o">=</span> <span class="n">_dur</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_addl_value</span> <span class="o">=</span> <span class="n">_addl</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_ii_value</span> <span class="o">=</span> <span class="n">_ii</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_ss_value</span> <span class="o">=</span> <span class="n">_ss</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>

        <span class="n">record</span> <span class="o">=</span> <span class="n">parse_record</span><span class="p">(</span>
            <span class="n">time</span><span class="o">=</span><span class="n">_time_value</span><span class="p">,</span>
            <span class="n">dv</span><span class="o">=</span><span class="n">_dv_value</span><span class="p">,</span>
            <span class="n">amt</span><span class="o">=</span><span class="n">_amt_value</span><span class="p">,</span>
            <span class="n">evid</span><span class="o">=</span><span class="n">_evid_value</span><span class="p">,</span>
            <span class="n">cmt</span><span class="o">=</span><span class="n">_cmt_value</span><span class="p">,</span>
            <span class="n">addl</span><span class="o">=</span><span class="n">_addl_value</span><span class="p">,</span>
            <span class="n">ii</span><span class="o">=</span><span class="n">_ii_value</span><span class="p">,</span>
            <span class="n">dur</span><span class="o">=</span><span class="n">_dur_value</span><span class="p">,</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">_rate_value</span><span class="p">,</span>
            <span class="n">ss</span><span class="o">=</span><span class="n">_ss_value</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">_index</span>
        <span class="p">)</span>
        <span class="n">_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_data</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">_data</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_data_rows</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_id</span><span class="p">),</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">_data</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">_data_rows</span><span class="p">)</span>  <span class="c1"># type:ignore</span>

    <span class="n">ev</span> <span class="o">=</span> <span class="n">ModelData</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">ModelData</span><span class="o">.</span><span class="n">_default_col_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="o">**</span><span class="n">ModelData</span><span class="o">.</span><span class="n">_default_col_mapping</span><span class="p">)</span>
    <span class="n">_units_set</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">base_time_unit</span><span class="p">,</span> <span class="n">base_amt_unit</span><span class="p">,</span> <span class="n">_rate</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="p">)</span>
    <span class="n">ev</span><span class="p">[</span><span class="n">_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="n">_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="c1"># 按照 ID 和 TIME 排序</span>
    <span class="n">ev</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;TIME&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ev</span><span class="o">.</span><span class="n">_update_dtype</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ev</span></div>


<span class="k">def</span> <span class="nf">_units_set</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">ModelData</span><span class="p">,</span>
    <span class="n">time_unit</span><span class="p">:</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">amt_unit</span><span class="p">:</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rate_unit</span><span class="p">:</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">data_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Model Data units setting</span>

<span class="sd">    Args:</span>
<span class="sd">        data (ModelData): model data</span>
<span class="sd">        time_unit (Unit | None): time unit</span>
<span class="sd">        amt_unit (Unit | None): amount unit</span>
<span class="sd">        rate_unit (Unit | None): rate unit</span>
<span class="sd">        data_mapping (Dict[str, str]): model data mapping</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_col_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;dur&quot;</span><span class="p">,</span> <span class="s2">&quot;ii&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;amt&quot;</span> <span class="ow">in</span> <span class="n">data_mapping</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">data_mapping</span><span class="p">[</span><span class="s2">&quot;amt&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">amt_unit</span>
    <span class="k">for</span> <span class="n">_col</span> <span class="ow">in</span> <span class="n">time_col_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_col</span> <span class="ow">in</span> <span class="n">data_mapping</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">data_mapping</span><span class="p">[</span><span class="n">_col</span><span class="p">]]</span><span class="o">.</span><span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">data_mapping</span><span class="p">[</span><span class="n">_col</span><span class="p">]]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">time_unit</span>
    <span class="k">if</span> <span class="s2">&quot;rate&quot;</span> <span class="ow">in</span> <span class="n">data_mapping</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rate_unit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">amt_unit</span> <span class="ow">and</span> <span class="n">time_unit</span><span class="p">:</span>
            <span class="n">rate_unit</span> <span class="o">=</span> <span class="n">RatioUnit</span><span class="p">(</span><span class="n">amt_unit</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">data_mapping</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">rate_unit</span>


<span class="k">def</span> <span class="nf">data_unit_covert</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">SelfType</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">:</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">amt_unit</span><span class="p">:</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rate_unit</span><span class="p">:</span> <span class="n">Unit</span> <span class="o">|</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SelfType</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Model Data units covert and modify in-place</span>

<span class="sd">    Args:</span>
<span class="sd">        data (ModelData): model data</span>
<span class="sd">        time_unit (Unit | None): converted time unit</span>
<span class="sd">        amt_unit (Unit | None): converted amount unit</span>
<span class="sd">        rate_unit (Unit | None): converted rate unit</span>

<span class="sd">    Returns:</span>
<span class="sd">        ModelData: The converted model data, the result is source data reference</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_col_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;dur&quot;</span><span class="p">,</span> <span class="s2">&quot;ii&quot;</span><span class="p">]</span>
    <span class="n">data_mapping</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">kwd_mapping</span>
    <span class="k">for</span> <span class="n">_col</span> <span class="ow">in</span> <span class="n">time_col_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_col</span> <span class="ow">in</span> <span class="n">data_mapping</span><span class="p">:</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="n">data_mapping</span><span class="p">[</span><span class="n">_col</span><span class="p">]</span>
            <span class="n">data_col_unit</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>
            <span class="k">if</span> <span class="n">data_col_unit</span> <span class="ow">and</span> <span class="n">time_unit</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_col_unit</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_unit</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_convert</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">],</span> <span class="n">from_unit</span><span class="o">=</span><span class="n">data_col_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="o">=</span><span class="n">time_unit</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">time_unit</span>
            <span class="k">elif</span> <span class="n">time_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;amt&quot;</span> <span class="ow">in</span> <span class="n">data_mapping</span><span class="p">:</span>
        <span class="n">colname</span> <span class="o">=</span> <span class="n">data_mapping</span><span class="p">[</span><span class="s2">&quot;amt&quot;</span><span class="p">]</span>
        <span class="n">data_col_unit</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">if</span> <span class="n">data_col_unit</span> <span class="ow">and</span> <span class="n">amt_unit</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">amt_unit</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_convert</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">],</span> <span class="n">from_unit</span><span class="o">=</span><span class="n">data_col_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="o">=</span><span class="n">amt_unit</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">amt_unit</span>

    <span class="k">if</span> <span class="s2">&quot;rate&quot;</span> <span class="ow">in</span> <span class="n">data_mapping</span><span class="p">:</span>
        <span class="n">colname</span> <span class="o">=</span> <span class="n">data_mapping</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span>
        <span class="n">data_col_unit</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">if</span> <span class="n">data_col_unit</span> <span class="ow">and</span> <span class="n">rate_unit</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rate_unit</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_convert</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">],</span> <span class="n">from_unit</span><span class="o">=</span><span class="n">data_col_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="o">=</span><span class="n">rate_unit</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">amt_unit</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">infer_mdv</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">ModelData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;infer model data mdv value&quot;&quot;&quot;</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">kwd_mapping</span>
    <span class="k">if</span> <span class="s2">&quot;dv&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dv is not mapped&quot;</span><span class="p">)</span>
    <span class="n">dv_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;dv&quot;</span><span class="p">]</span>
    <span class="n">mdv_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">))</span>
    <span class="k">if</span> <span class="s2">&quot;amt&quot;</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
        <span class="n">amt_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;amt&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;evid&quot;</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
            <span class="n">evid_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;evid&quot;</span><span class="p">]</span>
            <span class="n">mdv_series</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">evid_colname</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">mdv_series</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="n">evid_colname</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">dv_colname</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdv_series</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="n">amt_colname</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mdv_series</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="n">amt_colname</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">dv_colname</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mdv_series</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">dv_colname</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">mdv_series</span>


<span class="k">def</span> <span class="nf">_to_ditto_individual_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">ModelData</span><span class="p">,</span>
                                <span class="n">mod</span><span class="p">:</span> <span class="n">InterpretedModule</span><span class="p">,</span>
                                <span class="n">covariate_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DittoIndividualData</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;build C++ individual model data</span>

<span class="sd">    Args:</span>
<span class="sd">        data (ModelData): model data</span>
<span class="sd">        mod (InterpretedModule): model struct</span>
<span class="sd">        covariate_names (List[str] | None, optional): covariate columns. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[DittoIndividualData]: individual data list</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">_DataRecord</span><span class="p">:</span>
        <span class="n">time</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">dv</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">amt</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">cmt</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">evid</span><span class="p">:</span> <span class="n">DittoEventType</span>
        <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">dur</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">ss</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DittoEValue</span><span class="p">]</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">kwd_mapping</span>
    <span class="n">reserved_colnames</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reserved_colnames</span>
    <span class="n">amt_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amt&quot;</span><span class="p">)</span>
    <span class="n">idv_colname</span> <span class="o">=</span> <span class="n">reserved_colnames</span><span class="p">[</span><span class="s2">&quot;idv&quot;</span><span class="p">]</span>
    <span class="n">dv_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dv&quot;</span><span class="p">)</span>
    <span class="n">evid_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evid&quot;</span><span class="p">)</span>
    <span class="n">cmt_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cmt&quot;</span><span class="p">)</span>
    <span class="n">ii_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ii&quot;</span><span class="p">)</span>
    <span class="n">addl_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;addl&quot;</span><span class="p">)</span>
    <span class="n">rate_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rate&quot;</span><span class="p">)</span>
    <span class="n">dur_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dur&quot;</span><span class="p">)</span>
    <span class="n">ss_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ss&quot;</span><span class="p">)</span>
    <span class="n">mdv_colname</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mdv&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_record</span><span class="p">(</span><span class="n">ind_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_DataRecord</span><span class="p">],</span> <span class="n">record_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">row_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">amt_colname</span><span class="p">:</span>
            <span class="n">amt_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">amt_colname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">amt_value</span><span class="p">):</span>
                <span class="n">amt_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amt_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">idv_colname</span><span class="p">:</span>
            <span class="n">idv_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">idv_colname</span><span class="p">]</span>  <span class="c1"># type:ignore</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">idv_value</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;idv is None in row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2"> for subject </span><span class="si">{</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># raise ValueError(f&quot;idv is not mapping in data&quot;)</span>
            <span class="n">idv_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">dv_colname</span><span class="p">:</span>
            <span class="n">dv_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">dv_colname</span><span class="p">]</span>  <span class="c1"># type:ignore</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">dv_value</span><span class="p">):</span>
                <span class="n">dv_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dv_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">evid_colname</span><span class="p">:</span>
            <span class="n">evid_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">evid_colname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">evid_value</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;evid is None in </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2"> for subject </span><span class="si">{</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">amt_value</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">dv_value</span><span class="p">):</span>
                <span class="n">evid_value</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">amt_value</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">dv_value</span><span class="p">):</span>
                <span class="n">evid_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">amt_value</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">dv_value</span><span class="p">):</span>
                <span class="n">evid_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">evid_value</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">evid_value</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mdv_colname</span><span class="p">:</span>
            <span class="n">mdv_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">mdv_colname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">mdv_value</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MDV is None in row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2"> for subject </span><span class="si">{</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mdv_value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">dv_value</span><span class="p">):</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;warning: MDV=1 but DV is not nan in row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2"> for subject </span><span class="si">{</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">cmt_colname</span><span class="p">:</span>  <span class="c1"># 指定，必须不为空</span>
            <span class="n">cmt_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">cmt_colname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cmt_value</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">evid_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 给药</span>
                    <span class="n">cmt_value</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">index_dosing_cmt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cmt_value</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">index_observe_cmt</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">evid_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 给药</span>
                <span class="n">cmt_value</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">index_dosing_cmt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmt_value</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">index_observe_cmt</span>

        <span class="k">if</span> <span class="n">ii_colname</span><span class="p">:</span>
            <span class="n">ii_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">ii_colname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">ii_value</span><span class="p">):</span>
                <span class="n">ii_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ii_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">addl_colname</span><span class="p">:</span>
            <span class="n">addl_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">addl_colname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">addl_value</span><span class="p">):</span>
                <span class="n">addl_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addl_value</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">rate_colname</span><span class="p">:</span>
            <span class="n">rate_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">rate_colname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rate_value</span><span class="p">):</span>
                <span class="n">rate_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rate_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">dur_colname</span><span class="p">:</span>
            <span class="n">dur_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">dur_colname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">dur_value</span><span class="p">):</span>
                <span class="n">dur_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dur_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">ss_colname</span><span class="p">:</span>
            <span class="n">ss_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">record_series</span><span class="p">[</span><span class="n">ss_colname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">ss_value</span><span class="p">):</span>
                <span class="n">ss_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ss_value</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># 校验 ss addl ii</span>
        <span class="k">if</span> <span class="n">ss_value</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">addl_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Neither ss nor addl is None in row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2"> for subject </span><span class="si">{</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ss_value</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">ii_value</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;II is None in row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">addl_value</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">ii_value</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ii is None in row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ss_value</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">addl_value</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">ii_value</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ii is not None in row </span><span class="si">{</span><span class="n">row_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">covariates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DittoEValue</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">index</span><span class="p">:</span> <span class="nb">str</span>
        <span class="k">if</span> <span class="n">covariate_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">record_series</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">kwd_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">covariates</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">DittoEValue</span><span class="p">(</span><span class="n">record_series</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">covariate_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">covariates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">DittoEValue</span><span class="p">(</span><span class="n">record_series</span><span class="p">[</span><span class="n">mapping</span><span class="p">[</span><span class="n">name</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">covariates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">DittoEValue</span><span class="p">(</span><span class="n">record_series</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">evid_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 给药</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">addl_value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">addl_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 非多次给药</span>
                <span class="n">event_record</span> <span class="o">=</span> <span class="n">_DataRecord</span><span class="p">(</span>
                    <span class="n">amt</span><span class="o">=</span><span class="n">amt_value</span><span class="p">,</span>  <span class="c1"># type:ignore</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">idv_value</span><span class="p">,</span>
                    <span class="n">dv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="n">cmt</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cmt_value</span><span class="p">),</span>
                    <span class="n">evid</span><span class="o">=</span><span class="n">to_event_type</span><span class="p">(</span><span class="n">evid</span><span class="o">=</span><span class="n">evid_value</span><span class="p">),</span>
                    <span class="n">rate</span><span class="o">=</span><span class="n">rate_value</span><span class="p">,</span>
                    <span class="n">dur</span><span class="o">=</span><span class="n">dur_value</span><span class="p">,</span>
                    <span class="n">ss</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ss_value</span><span class="p">),</span>
                    <span class="n">covariates</span><span class="o">=</span><span class="n">covariates</span>
                <span class="p">)</span>
                <span class="n">insert_index</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect</span><span class="p">(</span><span class="n">ind_data</span><span class="p">,</span> <span class="n">event_record</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
                <span class="n">ind_data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_index</span><span class="p">,</span> <span class="n">event_record</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># 多次给药</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">addl_value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">idv_value</span> <span class="o">+</span> <span class="n">_</span> <span class="o">*</span> <span class="n">ii_value</span>  <span class="c1"># type: ignore</span>
                    <span class="n">event_record</span> <span class="o">=</span> <span class="n">_DataRecord</span><span class="p">(</span>
                        <span class="n">amt</span><span class="o">=</span><span class="n">amt_value</span><span class="p">,</span>  <span class="c1"># type:ignore</span>
                        <span class="n">time</span><span class="o">=</span><span class="n">_time</span><span class="p">,</span>
                        <span class="n">dv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                        <span class="n">cmt</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cmt_value</span><span class="p">),</span>
                        <span class="n">evid</span><span class="o">=</span><span class="n">to_event_type</span><span class="p">(</span><span class="n">evid</span><span class="o">=</span><span class="n">evid_value</span><span class="p">),</span>
                        <span class="n">rate</span><span class="o">=</span><span class="n">rate_value</span><span class="p">,</span>
                        <span class="n">dur</span><span class="o">=</span><span class="n">dur_value</span><span class="p">,</span>
                        <span class="n">ss</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ss_value</span><span class="p">),</span>
                        <span class="n">covariates</span><span class="o">=</span><span class="n">covariates</span>
                    <span class="p">)</span>
                    <span class="n">insert_index</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect</span><span class="p">(</span><span class="n">ind_data</span><span class="p">,</span> <span class="n">event_record</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
                    <span class="n">ind_data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_index</span><span class="p">,</span> <span class="n">event_record</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 观测</span>
            <span class="c1"># if not pd.isnull(dv_value):  # TODO: 目前处理不了空的 dv</span>
            <span class="n">event_record</span> <span class="o">=</span> <span class="n">_DataRecord</span><span class="p">(</span>
                <span class="n">time</span><span class="o">=</span><span class="n">idv_value</span><span class="p">,</span>
                <span class="n">dv</span><span class="o">=</span><span class="n">dv_value</span><span class="p">,</span>  <span class="c1"># type:ignore</span>
                <span class="n">amt</span><span class="o">=</span><span class="n">amt_value</span><span class="p">,</span>  <span class="c1"># type:ignore</span>
                <span class="n">cmt</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cmt_value</span><span class="p">),</span>
                <span class="n">evid</span><span class="o">=</span><span class="n">to_event_type</span><span class="p">(</span><span class="n">evid</span><span class="o">=</span><span class="n">evid_value</span><span class="p">),</span>
                <span class="n">rate</span><span class="o">=</span><span class="n">rate_value</span><span class="p">,</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">dur_value</span><span class="p">,</span>
                <span class="n">ss</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ss_value</span><span class="p">),</span>
                <span class="n">covariates</span><span class="o">=</span><span class="n">covariates</span>
            <span class="p">)</span>
            <span class="n">insert_index</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect</span><span class="p">(</span><span class="n">ind_data</span><span class="p">,</span> <span class="n">event_record</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="n">ind_data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_index</span><span class="p">,</span> <span class="n">event_record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_ind_dataframe</span><span class="p">(</span><span class="n">ind_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DittoDataRecord</span><span class="p">]:</span>
        <span class="n">et_df_rows</span> <span class="o">=</span> <span class="n">ind_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">_individual_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_DataRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">et_df_rows</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">ind_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row_index</span><span class="p">]</span>
            <span class="n">_parse_record</span><span class="p">(</span><span class="n">_individual_data</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">row_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_id</span><span class="p">)</span>

        <span class="n">individual_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DittoDataRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">_individual_data</span><span class="p">:</span>
            <span class="n">individual_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">DittoDataRecord</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                    <span class="n">dv</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">dv</span><span class="p">,</span>
                    <span class="n">amt</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">amt</span><span class="p">,</span>
                    <span class="n">evid</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">evid</span><span class="p">,</span>
                    <span class="n">cmt</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">cmt</span><span class="p">,</span>
                    <span class="n">rate</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span>
                    <span class="n">dur</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">dur</span><span class="p">,</span>
                    <span class="n">ss</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">ss</span><span class="p">,</span>
                    <span class="n">covariates</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">covariates</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">individual_data</span>

    <span class="n">data_by_id</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DittoIndividualData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reserved_colnames</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subject</span><span class="p">:</span>
        <span class="n">_id</span><span class="p">:</span> <span class="nb">int</span>
        <span class="k">for</span> <span class="n">_id</span><span class="p">,</span> <span class="n">_sub_df</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">subject</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
            <span class="n">individual_data</span> <span class="o">=</span> <span class="n">_parse_ind_dataframe</span><span class="p">(</span><span class="n">_sub_df</span><span class="p">,</span> <span class="n">_id</span><span class="p">)</span>
            <span class="n">data_by_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DittoIndividualData</span><span class="p">(</span><span class="n">individual_data</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">individual_data</span> <span class="o">=</span> <span class="n">_parse_ind_dataframe</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">data_by_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DittoIndividualData</span><span class="p">(</span><span class="n">individual_data</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">data_by_id</span>
</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, Maspectra Dev Team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>